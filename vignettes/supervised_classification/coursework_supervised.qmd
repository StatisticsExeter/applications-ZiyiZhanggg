---
title: "Building a classifier to predict house age"
author: "Anonymous"
format: 
  html:
    embed-resources: True

---

```{r}
#| include: false
Sys.setenv(RETICULATE_PYTHON = "D:/Anaconda/envs/python-exercises/python.exe")
library(reticulate)
use_python(Sys.getenv("RETICULATE_PYTHON"), required = TRUE)
py_config()
```

## Introduction

This report explores whether basic EPC energy metrics can be used to classify properties into pre-1930 vs post-1930 build age groups, to support local retrofit targeting.

## The Problem

Data on [Energy Certificates](https://epc.opendatacommunities.org/) were downloaded in March 2025. These certificates are a non-random sample of UK housing, and contain information such as:

- Property energy efficiency: The core data is the energy efficiency rating, which ranges from A (most efficient) to G (least efficient).
- CO2 emissions: The data includes information on the building's likely carbon dioxide emissions.
- Energy costs: Potential costs for heating and lighting the property are provided.
- Improvement recommendations: Each EPC lists cost-effective ways to improve the building's energy performance.

In all, there are 93 variables available on a wide range of metrics. The full dataset is in the course database server at `10.121.4.250` in `energy.energy_certificates`

The data have been used for various published supervised classification exercises:

- ONS data science campus EPC data to predict energy efficiency ratings across Welsh properties. They applied models like XGBoost and found that features such as floor area, number of habitable rooms, and extension count were most predictive <https://datasciencecampus.ons.gov.uk/projects/using-machine-learning-to-predict-energy-efficiency/>
- EPC anomaly detection (improve data quality) <https://www.iaarc.org/publications/fulltext/102_A_Comprehensive_Approach_for_Automated_Anomaly_Detection_and_Enhancement_of_EPC_Datasets_for_Decarbonization.pdf>
- Identifying priorities for retrofit strategy <https://uwlpress.uwl.ac.uk/newvistas/article/id/299/>
- EPC prediction <https://github.com/yourunclefrankie/Energy-efficiency-prediction>

In reducing the carbon footprint of UK housing, it is important to develop a strategy that offers the right solutions to the right properties. It is widely believed that houses built before 1930 require very different approaches to houses built after that period.  In this task, the aim is to assess whether the age of a house can be inferred from recorded energy metrics. These include a range of recorded energy efficiency, environmental impact, energy consumption, emissions, and cost-related indicators. This information could help local authorities identify appropriate targets using recorded energy metrics, without requiring a physical inspection of each property.



## The Data

```{python}
#| echo: false
import pandas as pd
```

```{python}
#| echo: false
#| results: 'asis'
df = pd.read_csv('../../data_cache/vignettes/supervised_classification/frequencies.csv')
print(df.round(3).to_markdown(index=False))
```

```{python}
#| echo: false
#| results: 'asis'
df = pd.read_csv('../../data_cache/vignettes/supervised_classification/grouped_stats.csv')
df = df.rename(columns={"Unnamed: 0": "metric"})
df_small = df[df["metric"].str.endswith(("_mean", "_std"))]
print(df_small.round(3).to_markdown(index=False))
```

The dataset contains several energy-related variables recorded for domestic properties within a single local authority.

The target variable is `built_age`, which is grouped into two categories (pre-1930 vs post-1930). For classification, the following predictors are used:

- current_energy_efficiency  
- environment_impact_current  
- energy_consumption_current  
- co2_emissions_current  
- lighting_cost_current  
- heating_cost_current  
- hot_water_cost_current  

A simple examination of the frequency table and grouped summary statistics suggests that the two age groups differ across several variables, with particularly clear differences in energy consumption and CO₂ emissions.

## Methods

This report uses EPC data from a single local authority and examines whether a small set of energy-related variables can be used to predict whether a property was built before or after 1930.

Using the predictors described in the previous section, I treat `built_age` as a binary outcome and fit two baseline classifiers: LDA and QDA.

Model performance is evaluated on the test set rather than the training set, so the reported results reflect how well the models generalise to unseen data. Performance is assessed using precision, recall, and F1 score, alongside ROC curves and AUC values, which provide a threshold-free summary of how well the two classes are separated.

## Exploratory Data Analysis (EDA)

The scatterplot matrix reveals several clear patterns among the energy-related variables.

![](./figures/supervised_scatterplot.png){width="100%"}

```{python}
#| echo: false
from pathlib import Path
import pandas as pd
import plotly.express as px

df = pd.read_csv("../../data_cache/energy.csv")

out_dir = Path("figures")
out_dir.mkdir(exist_ok=True)

fig1 = px.scatter(
df,
x="current_energy_efficiency",
y="environment_impact_current",
color="built_age",
title="Efficiency vs Environmental impact",
)
fig1.write_html(out_dir / "eda_eff_vs_impact.html", include_plotlyjs="cdn")

fig2 = px.scatter(
df,
x="current_energy_efficiency",
y="energy_consumption_current",
color="built_age",
title="Efficiency vs Energy consumption",
)
fig2.write_html(out_dir / "eda_eff_vs_consumption.html", include_plotlyjs="cdn")
```
```{=html}
<div style="display:flex; gap:16px; align-items:flex-start;">
  <img src="figures/eda_eff_vs_impact.png" style="width:49%; height:auto;">
  <img src="figures/eda_eff_vs_consumption.png" style="width:49%; height:auto;">
</div>
```

Measures of energy efficiency and environmental impact are strongly aligned, with higher efficiency scores generally corresponding to better environmental impact scores. In contrast, energy efficiency tends to vary inversely with energy consumption, as less efficient homes typically exhibit higher levels of energy use.

While the two age groups show substantial overlap across most variable pairs, some systematic differences are still visible. Older properties are more often associated with higher energy consumption and CO₂ emissions, although no single variable provides a clear separation between pre-1930 and post-1930 homes.

Overall, the degree of overlap suggests that house age is unlikely to be well predicted using any single metric alone. However, the consistent differences in energy profiles across multiple variables provide motivation for applying multivariate classification methods such as LDA and QDA.


## Fitting LDA and QDA classifiers

### Results from fitting a linear discriminant analysis

```{python}
#| echo: false
#| results: 'asis'
df = pd.read_csv('../../data_cache/vignettes/supervised_classification/lda.csv')
df.rename(columns={"Unnamed: 0": "Category"}, inplace=True)
print(df.round(3).to_markdown(index=False))
```


### Results from fitting a quadratic discriminant analysis

```{python}
#| echo: false
#| results: 'asis'
df = pd.read_csv('../../data_cache/vignettes/supervised_classification/qda.csv')
df.rename(columns={"Unnamed: 0": "Category"}, inplace=True)
print(df.round(3).to_markdown(index=False))
```

Based on the results, LDA shows relatively stable performance across the two age groups. The accuracy is around 0.74, and precision and recall are similar for both classes, mostly falling between 0.70 and 0.77. This indicates that LDA treats pre-1930 and post-1930 properties in a fairly balanced way, with comparable recognition performance for each group.

QDA performs less well by comparison. Accuracy drops to around 0.61, and performance differs markedly between the two classes. While recall for Post-30s is very high at 0.907, recall for Pre-30s is much lower at 0.368. This pattern reflects a tendency for QDA to classify many properties as Post-30s, capturing most newer homes while missing a substantial proportion of older ones.

In this setting, LDA is the more appropriate model, as it achieves stronger performance and maintains a more even balance between the two age groups.


## ROC curve (and AUC) for two simple classifiers

The ROC curve illustrates how model performance varies as the classification threshold changes, summarising the trade-off between true positive and false positive rates. Curves that lie closer to the top-left corner indicate stronger separation between the two built age groups, while the diagonal corresponds to random classification.

![](./figures/supervised_roc.png){width="100%"}

```{python}
#| echo: false
#| results: 'asis'
import pandas as pd
from sklearn.preprocessing import LabelEncoder
from sklearn.metrics import roc_auc_score

y_test = pd.read_csv("../../data_cache/energy_y_test.csv").squeeze()
lda_prob = pd.read_csv("../../data_cache/models/lda_y_pred_prob.csv").squeeze()
qda_prob = pd.read_csv("../../data_cache/models/qda_y_pred_prob.csv").squeeze()

le = LabelEncoder()
y_test_enc = le.fit_transform(y_test)

auc_lda = roc_auc_score(y_test_enc, lda_prob)
auc_qda = roc_auc_score(y_test_enc, qda_prob)

df_res = pd.DataFrame({
    "Model": ["LDA", "QDA"], 
    "AUC": [auc_lda, auc_qda]
})

print("\n")
print(df_res.round(3).to_markdown(index=False))
print("\n")
```

Both models perform clearly better than random guessing, as reflected by their AUC values. This indicates that the energy-related metrics contain meaningful information for distinguishing between pre-1930 and post-1930 properties, even though substantial overlap between the two groups remains.

When comparing the classifiers, LDA achieves a slightly higher AUC than QDA. Although the difference is modest, it aligns with the earlier performance metrics that QDA shows more uneven behaviour across classes, whereas LDA provides more consistent discrimination. In this context, the simpler structure of LDA appears sufficient, and the additional flexibility of QDA does not lead to improved separation.

## Conclusion

The energy-related metrics contain useful signal for distinguishing older from newer properties, although the separation between the two groups is far from perfect. As a result, this approach is better viewed as a practical screening tool rather than a definitive method for determining building age.

Between the two baseline models, LDA performs more reliably on this dataset. It produces a more balanced pattern of precision and recall across both classes and achieves a slightly higher AUC than QDA (0.812 versus 0.794). By contrast, QDA shows uneven behaviour, with very high recall for Post-30s but substantially lower recall for Pre-30s, leading to many older properties being missed.

In practice, LDA is therefore the safer baseline choice. It could be used to prioritise properties for further checks or targeted retrofit support, while recognising that some degree of overlap and misclassification is unavoidable.


## Record of AI use for MTHM503 supervised coursework

| **Date**       | **AI tool used** | **Purpose**                                | **Prompt**                                 | **Hyperlink to output (where possible)** | **Section of work used for** |
|----------------|------------------|--------------------------------------------|--------------------------------------------|------------------------------------------|-------------------------------|
| E.g. 15/07/2025| MS Copilot       | To help create an organised essay structure| ‘Generate ideas for structuring an essay on...’ | [insert link]                          | introduction                  |
| 21/12/2025     | ChatGPT          | To help debug relative paths for including locally generated figures in Quarto HTML  | how to generate a figure in HTML |                              | figure  
| 22/12/25       |  Gemini         |  Help standardise the table format                        |  Figures not showing in rendered HTML (404 / broken images). Provide the simplest path fix and embedding approach.                |                                          |   report formatting                        |
| 22/12/25       |  ChatGPT            |  Assist with debugging pipeline errors and understanding why tests were failing                  |   Pytest fails in supervised pipeline (metrics.py / eda.py). Explain the error.      |                                          |           pipeline                    |
|                |                  |                                            |                                            |                                          |                               |
|                |                  |                                            |                                            |                                          |                               |
|                |                  |                                            |                                            |                                          |                               |
|                |                  |                                            |                                            |                                          |                               |
|                |                  |                                            |                                            |                                          |                               |

